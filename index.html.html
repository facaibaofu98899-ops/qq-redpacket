<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQæ‰‹æ°”çº¢åŒ…å°¾æ•°é¢„æµ‹ç³»ç»Ÿ - ç»¼åˆå¢å¼ºç‰ˆ</title>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .upload-float-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s;
        }
        
        .upload-float-btn:hover {
            transform: scale(1.1);
        }
        
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }
        
        .upload-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        
        .tail-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            margin: 5px;
            font-weight: bold;
        }
        
        .confidence-high { color: #2ecc71; font-weight: bold; }
        .confidence-medium { color: #f39c12; font-weight: bold; }
        .confidence-low { color: #e74c3c; font-weight: bold; }
        
        .history-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .correct-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .chart-container {
            height: 200px;
            margin: 20px 0;
        }
        
        .prediction-result {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .image-preview-container {
            position: relative;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            max-width: 100%;
            max-height: 400px;
            overflow: auto;
        }
        
        #imagePreview {
            max-width: 100%;
            display: block;
        }
        
        .selection-box {
            position: absolute;
            border: 2px solid #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
            pointer-events: none;
        }
        
        .selection-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #ff6b6b;
            color: white;
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 3px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        .control-group h4 {
            margin-bottom: 10px;
            color: #333;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .slider-label span {
            font-size: 14px;
            color: #555;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 15px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        button.success {
            background: #2ecc71;
        }
        
        button.success:hover {
            background: #27ae60;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        
        .status-message.error {
            border-left-color: #e74c3c;
            background: #ffeaea;
        }
        
        .status-message.success {
            border-left-color: #2ecc71;
            background: #eaffea;
        }
        
        .manual-input {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .manual-input h4 {
            margin-bottom: 10px;
        }
        
        .amount-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .amount-input {
            display: flex;
            align-items: center;
        }
        
        .amount-input label {
            width: 60px;
            margin-right: 5px;
        }
        
        .amount-input input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .preset-button {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .preset-button:hover {
            background: #8e44ad;
        }
        
        /* æ–°å¢æ ·å¼ - ä»åŠ å¼ºç‰ˆä¸­æå– */
        .enhanced-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .enhanced-controls button {
            flex: 1;
            min-width: 140px;
        }
        
        .progress-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .accuracy-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .high-accuracy {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .medium-accuracy {
            background: #fff8e1;
            color: #f57c00;
        }
        
        .low-accuracy {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .auto-mode {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .auto-mode label {
            margin-left: 8px;
        }
        
        .amount-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .amount-item:last-child {
            border-bottom: none;
        }
        
        .amount-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        
        @media (max-width: 600px) {
            .tab-button {
                min-width: 100px;
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .amount-inputs {
                grid-template-columns: 1fr;
            }
            
            .preset-buttons {
                flex-direction: column;
            }
            
            .enhanced-controls button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- æµ®åŠ¨ä¸Šä¼ æŒ‰é’® -->
    <div class="upload-float-btn" onclick="openUploadModal()">
        ğŸ“·
    </div>

    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-content">
            <h3>QQçº¢åŒ…æ•°æ®å½•å…¥ç³»ç»Ÿ - å¢å¼ºç‰ˆ</h3>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('uploadTab')">ä¸Šä¼ æˆªå›¾</button>
                <button class="tab-button" onclick="switchTab('adjustTab')">åŒºåŸŸè°ƒæ•´</button>
                <button class="tab-button" onclick="switchTab('manualTab')">æ‰‹åŠ¨è¾“å…¥</button>
                <button class="tab-button" onclick="switchTab('resultTab')">ç»“æœç¡®è®¤</button>
            </div>
            
            <div id="uploadTab" class="tab-content active">
                <p>è¯·ä¸Šä¼ QQæ‰‹æ°”çº¢åŒ…é¢†å–å®Œæ¯•çš„æˆªå›¾</p>
                <div class="upload-area" id="uploadArea">
                    <div style="text-align: center; padding: 30px; border: 2px dashed #ddd; border-radius: 10px; cursor: pointer;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ QQçº¢åŒ…æˆªå›¾</p>
                        <p style="color: #888; font-size: 0.9rem;">å»ºè®®ä½¿ç”¨æ¸…æ™°æˆªå›¾ä»¥æé«˜è¯†åˆ«å‡†ç¡®ç‡</p>
                    </div>
                </div>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                
                <div class="auto-mode">
                    <input type="checkbox" id="autoSave" checked>
                    <label for="autoSave">è‡ªåŠ¨ä¿å­˜è¯†åˆ«ç»“æœå¹¶åˆ†ææ¨è</label>
                </div>
                
                <div class="status-message">
                    <p><strong>æç¤ºï¼š</strong>å¦‚æœè‡ªåŠ¨è¯†åˆ«ä¸å‡†ç¡®ï¼Œå¯ä»¥ä½¿ç”¨"æ‰‹åŠ¨è¾“å…¥"æ ‡ç­¾ç›´æ¥è¾“å…¥æ•°æ®</p>
                </div>
                
                <div id="uploadStatus" class="status-message"></div>
                <button onclick="loadImageForAdjustment()">ä¸‹ä¸€æ­¥ï¼šè°ƒæ•´è¯†åˆ«åŒºåŸŸ</button>
            </div>
            
            <div id="adjustTab" class="tab-content">
                <p>è¯·è°ƒæ•´è¯†åˆ«åŒºåŸŸï¼Œç¡®ä¿çº¢è‰²æ¡†å®Œå…¨è¦†ç›–é‡‘é¢ä¿¡æ¯</p>
                <div class="image-preview-container">
                    <img id="imagePreview" src="" alt="é¢„è§ˆå›¾ç‰‡">
                    <!-- è¯†åˆ«åŒºåŸŸæ¡†å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                
                <div class="control-panel">
                    <div class="control-group">
                        <h4>è£åˆ‡åŒºåŸŸè°ƒæ•´</h4>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>å·¦: <span id="cropLeftVal">70</span>%</span>
                            </div>
                            <input type="range" min="50" max="90" value="70" class="slider" id="cropLeft">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>å®½: <span id="cropWidthVal">25</span>%</span>
                            </div>
                            <input type="range" min="10" max="40" value="25" class="slider" id="cropWidth">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>ä¸Š: <span id="cropTopVal">15</span>%</span>
                            </div>
                            <input type="range" min="0" max="40" value="15" class="slider" id="cropTop">
                        </div>
                        
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>é«˜: <span id="cropHeightVal">80</span>%</span>
                            </div>
                            <input type="range" min="50" max="100" value="80" class="slider" id="cropHeight">
                        </div>
                        
                        <div class="preset-buttons">
                            <button class="preset-button" onclick="setDefaultCrop()">è‡ªåŠ¨è£åˆ‡å³ä¾§åˆ—</button>
                        </div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress" id="ocrProgress"></div>
                </div>
                
                <div class="enhanced-controls">
                    <button class="btn-secondary" id="enhancedOCRBtn">å¢å¼ºè¯†åˆ«æ¨¡å¼</button>
                    <button class="success" onclick="doEnhancedOCR()">å¼€å§‹è¯†åˆ«</button>
                </div>
                
                <button onclick="switchTab('uploadTab')">ä¸Šä¸€æ­¥</button>
                <button onclick="switchTab('manualTab')">è·³è¿‡è¯†åˆ«ï¼Œæ‰‹åŠ¨è¾“å…¥</button>
            </div>
            
            <div id="manualTab" class="tab-content">
                <div class="manual-input">
                    <h4>æ‰‹åŠ¨è¾“å…¥çº¢åŒ…æ•°æ®</h4>
                    <p>å¦‚æœè‡ªåŠ¨è¯†åˆ«ä¸å‡†ç¡®ï¼Œè¯·åœ¨æ­¤ç›´æ¥è¾“å…¥æ­£ç¡®æ•°æ®</p>
                    
                    <div class="amount-input">
                        <label for="manualTotalAmount">æ€»é‡‘é¢:</label>
                        <input type="number" step="0.01" id="manualTotalAmount" placeholder="ä¾‹å¦‚: 5.00">
                    </div>
                    
                    <div class="amount-input">
                        <label for="manualPacketCount">çº¢åŒ…ä¸ªæ•°:</label>
                        <input type="number" id="manualPacketCount" placeholder="ä¾‹å¦‚: 9">
                    </div>
                    
                    <h4>æ¯ä¸ªçº¢åŒ…é‡‘é¢ (è¯·æŒ‰é¡ºåºè¾“å…¥):</h4>
                    <div class="amount-inputs" id="manualAmountInputs">
                        <!-- åŠ¨æ€ç”Ÿæˆé‡‘é¢è¾“å…¥æ¡† -->
                    </div>
                    
                    <button onclick="addAmountField()">æ·»åŠ é‡‘é¢å­—æ®µ</button>
                    <button onclick="removeAmountField()">åˆ é™¤æœ€åä¸€ä¸ªé‡‘é¢å­—æ®µ</button>
                </div>
                
                <button class="success" onclick="saveManualData()">ä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„æ•°æ®</button>
                <button onclick="switchTab('adjustTab')">è¿”å›è‡ªåŠ¨è¯†åˆ«</button>
            </div>
            
            <div id="resultTab" class="tab-content">
                <h4>è¯†åˆ«ç»“æœ</h4>
                <div id="ocrResult"></div>
                
                <div id="amountListContainer" style="display: none;">
                    <h4>è¯†åˆ«å‡ºçš„é‡‘é¢ï¼ˆå¯ç¼–è¾‘ï¼‰ <span id="accuracyBadge" class="accuracy-badge" style="display: none;">å‡†ç¡®ç‡: é«˜</span></h4>
                    <div class="amount-list" id="amountList">
                        <div style="text-align: center; padding: 20px; color: #888;">æ— è¯†åˆ«æ•°æ®</div>
                    </div>
                </div>
                
                <div id="correctionArea"></div>
                <button class="success" onclick="saveData()">ä¿å­˜æ•°æ®å¹¶é¢„æµ‹</button>
                <button onclick="switchTab('adjustTab')">é‡æ–°è¯†åˆ«</button>
                <button onclick="switchTab('manualTab')">æ‰‹åŠ¨è¾“å…¥</button>
            </div>
            
            <button class="danger" onclick="closeUploadModal()" style="margin-top: 15px;">å…³é—­</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¯ QQæ‰‹æ°”çº¢åŒ…å°¾æ•°é¢„æµ‹ç³»ç»Ÿ - ç»¼åˆå¢å¼ºç‰ˆ</h1>
            <p>åŸºäºå†å²æ•°æ®çš„æ™ºèƒ½å°¾æ•°é¢„æµ‹ + å¢å¼ºOCRè¯†åˆ«</p>
        </div>

        <!-- å½“å‰æ•°æ®å±•ç¤º -->
        <div class="section">
            <h3>ğŸ“Š æœ€æ–°çº¢åŒ…æ•°æ®</h3>
            <div id="currentData"></div>
        </div>

        <!-- é¢„æµ‹ç»“æœ -->
        <div class="section">
            <h3>ğŸ”® é¢„æµ‹ç»“æœ</h3>
            <div id="predictionResult"></div>
            <div class="chart-container">
                <canvas id="tailDistributionChart"></canvas>
            </div>
        </div>

        <!-- å†å²è®°å½• -->
        <div class="section">
            <h3>ğŸ“ˆ å†å²è®°å½•</h3>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let redPacketHistory = JSON.parse(localStorage.getItem('redPacketHistory')) || [];
        let currentOCRData = null;
        let tailDistributionChart = null;
        let currentImage = null;
        let imageWidth = 0;
        let imageHeight = 0;
        let recognizedAmounts = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateHistoryDisplay();
            if (redPacketHistory.length > 0) {
                generatePrediction();
            }
            initializeManualInputs();
            setupSliders();
            setupUploadArea();
        });
        
        // è®¾ç½®ä¸Šä¼ åŒºåŸŸ
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('imageUpload');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.backgroundColor = 'rgba(102, 126, 234, 0.05)';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = '';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ddd';
                uploadArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    loadImageForAdjustment();
                }
            });
        }
        
        // è®¾ç½®æ»‘å—äº‹ä»¶ç›‘å¬
        function setupSliders() {
            // è£åˆ‡åŒºåŸŸæ»‘å—
            document.getElementById('cropLeft').addEventListener('input', function() {
                document.getElementById('cropLeftVal').textContent = this.value;
                if (currentImage) drawCropOverlay();
            });
            
            document.getElementById('cropWidth').addEventListener('input', function() {
                document.getElementById('cropWidthVal').textContent = this.value;
                if (currentImage) drawCropOverlay();
            });
            
            document.getElementById('cropTop').addEventListener('input', function() {
                document.getElementById('cropTopVal').textContent = this.value;
                if (currentImage) drawCropOverlay();
            });
            
            document.getElementById('cropHeight').addEventListener('input', function() {
                document.getElementById('cropHeightVal').textContent = this.value;
                if (currentImage) drawCropOverlay();
            });
        }
        
        // è®¾ç½®é»˜è®¤è£åˆ‡
        function setDefaultCrop() {
            document.getElementById('cropLeft').value = 70;
            document.getElementById('cropWidth').value = 25;
            document.getElementById('cropTop').value = 15;
            document.getElementById('cropHeight').value = 80;
            
            document.getElementById('cropLeftVal').textContent = '70';
            document.getElementById('cropWidthVal').textContent = '25';
            document.getElementById('cropTopVal').textContent = '15';
            document.getElementById('cropHeightVal').textContent = '80';
            
            if (currentImage) drawCropOverlay();
        }
        
        // ç»˜åˆ¶è£åˆ‡è¦†ç›–å±‚
        function drawCropOverlay() {
            if (!currentImage) return;
            
            const canvas = document.getElementById('imagePreview');
            const ctx = canvas.getContext('2d');
            
            // æ¸…é™¤å¹¶é‡ç»˜å›¾åƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            // è®¡ç®—è£åˆ‡åŒºåŸŸ
            const leftP = parseInt(document.getElementById('cropLeft').value) / 100;
            const widthP = parseInt(document.getElementById('cropWidth').value) / 100;
            const topP = parseInt(document.getElementById('cropTop').value) / 100;
            const heightP = parseInt(document.getElementById('cropHeight').value) / 100;
            
            const x = canvas.width * leftP;
            const y = canvas.height * topP;
            const w = canvas.width * widthP;
            const h = canvas.height * heightP;
            
            // ç»˜åˆ¶åŠé€æ˜è¦†ç›–å±‚
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ¸…é™¤è£åˆ‡åŒºåŸŸ
            ctx.clearRect(x, y, w, h);
            
            // ç»˜åˆ¶è£åˆ‡åŒºåŸŸè¾¹æ¡†
            ctx.strokeStyle = '#e54d42';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
        }
        
        // è·å–è£åˆ‡åçš„å›¾åƒ
        function getCroppedImage() {
            if (!currentImage) return null;
            
            const leftP = parseInt(document.getElementById('cropLeft').value) / 100;
            const widthP = parseInt(document.getElementById('cropWidth').value) / 100;
            const topP = parseInt(document.getElementById('cropTop').value) / 100;
            const heightP = parseInt(document.getElementById('cropHeight').value) / 100;
            
            const sx = currentImage.width * leftP;
            const sy = currentImage.height * topP;
            const sw = currentImage.width * widthP;
            const sh = currentImage.height * heightP;
            
            // åˆ›å»ºä¸´æ—¶Canvasè¿›è¡Œè£åˆ‡
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = sw;
            tempCanvas.height = sh;
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCtx.drawImage(currentImage, sx, sy, sw, sh, 0, 0, sw, sh);
            
            return tempCanvas.toDataURL('image/jpeg');
        }
        
        // åˆå§‹åŒ–æ‰‹åŠ¨è¾“å…¥æ¡†
        function initializeManualInputs() {
            const container = document.getElementById('manualAmountInputs');
            // åˆå§‹åˆ›å»º9ä¸ªè¾“å…¥æ¡†ï¼ˆå¯¹åº”9ä¸ªçº¢åŒ…ï¼‰
            for (let i = 0; i < 9; i++) {
                const div = document.createElement('div');
                div.className = 'amount-input';
                div.innerHTML = `
                    <label>çº¢åŒ…${i+1}:</label>
                    <input type="number" step="0.01" class="manual-amount" placeholder="0.00">
                `;
                container.appendChild(div);
            }
        }
        
        // æ·»åŠ é‡‘é¢è¾“å…¥æ¡†
        function addAmountField() {
            const container = document.getElementById('manualAmountInputs');
            const count = container.children.length;
            const div = document.createElement('div');
            div.className = 'amount-input';
            div.innerHTML = `
                <label>çº¢åŒ…${count+1}:</label>
                <input type="number" step="0.01" class="manual-amount" placeholder="0.00">
            `;
            container.appendChild(div);
        }
        
        // åˆ é™¤æœ€åä¸€ä¸ªé‡‘é¢è¾“å…¥æ¡†
        function removeAmountField() {
            const container = document.getElementById('manualAmountInputs');
            if (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
        }
        
        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // å–æ¶ˆæ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
        }
        
        // ä¸Šä¼ æ¨¡æ€æ¡†æ§åˆ¶
        function openUploadModal() {
            document.getElementById('uploadModal').style.display = 'flex';
            switchTab('uploadTab');
            document.getElementById('uploadStatus').innerHTML = '';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            // æ¸…ç†èµ„æº
            if (currentImage) {
                URL.revokeObjectURL(currentImage.src);
            }
        }
        
        // åŠ è½½å›¾ç‰‡ç”¨äºè°ƒæ•´è¯†åˆ«åŒºåŸŸ
        function loadImageForAdjustment() {
            const fileInput = document.getElementById('imageUpload');
            if (!fileInput.files[0]) {
                showStatus('è¯·å…ˆé€‰æ‹©å›¾ç‰‡', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const imagePreview = document.getElementById('imagePreview');
            
            // åˆ›å»ºå›¾ç‰‡å¯¹è±¡
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                imageWidth = img.width;
                imageHeight = img.height;
                
                // è®¾ç½®é¢„è§ˆå®¹å™¨å°ºå¯¸
                const container = imagePreview.parentElement;
                container.style.maxWidth = '100%';
                
                // åˆ›å»ºCanvasç”¨äºæ˜¾ç¤ºè£åˆ‡åŒºåŸŸ
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                imagePreview.src = canvas.toDataURL('image/jpeg');
                
                // åˆ‡æ¢åˆ°è°ƒæ•´æ ‡ç­¾
                switchTab('adjustTab');
                
                // ç»˜åˆ¶è£åˆ‡è¦†ç›–å±‚
                setTimeout(() => {
                    drawCropOverlay();
                }, 100);
            };
            
            img.src = URL.createObjectURL(file);
        }
        
        // å¢å¼ºOCRè¯†åˆ«
        async function doEnhancedOCR() {
            if (!currentImage) {
                showStatus('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }
            
            const btn = document.getElementById('enhancedOCRBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> è¯†åˆ«ä¸­...';
            showStatus('OCRè¯†åˆ«ä¸­...', '');
            document.getElementById('ocrProgress').style.width = '0%';
            
            try {
                const imageData = getCroppedImage();
                
                // å¢å¼ºæ¨¡å¼ï¼šå¤šæ¬¡è¯†åˆ«å¹¶å–æœ€ä½³ç»“æœ
                const results = [];
                
                // ç¬¬ä¸€æ¬¡è¯†åˆ«
                updateProgress(0.2);
                const result1 = await Tesseract.recognize(imageData, 'chi_sim+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(0.2 + m.progress * 0.3);
                        }
                    }
                });
                results.push(result1);
                
                // è°ƒæ•´å‚æ•°åç¬¬äºŒæ¬¡è¯†åˆ«
                updateProgress(0.6);
                const result2 = await Tesseract.recognize(imageData, 'chi_sim+eng', {
                    tessjs_create_tsv: '1',
                    tessjs_create_box: '1',
                    tessjs_create_unlv: '1',
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            updateProgress(0.6 + m.progress * 0.2);
                        }
                    }
                });
                results.push(result2);
                
                // é€‰æ‹©ç½®ä¿¡åº¦æœ€é«˜çš„ç»“æœ
                const bestResult = results.reduce((best, current) => 
                    current.data.confidence > best.data.confidence ? current : best
                );
                
                const text = bestResult.data.text;
                const words = bestResult.data.words;
                
                updateProgress(1);
                
                // æå–é‡‘é¢
                extractAmountsFromOCR(text, words);
                
                // å¦‚æœå¼€å¯äº†è‡ªåŠ¨æ¨¡å¼ï¼Œè‡ªåŠ¨ä¿å­˜å¹¶åˆ†æ
                if (document.getElementById('autoSave').checked) {
                    setTimeout(saveData, 500);
                }
                
            } catch (error) {
                console.error('OCR Error:', error);
                showStatus('è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å¢å¼ºè¯†åˆ«æ¨¡å¼';
                setTimeout(() => { document.getElementById('ocrProgress').style.width = '0%'; }, 1000);
            }
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progress) {
            const percent = progress * 100;
            document.getElementById('ocrProgress').style.width = `${percent}%`;
        }
        
        // ä»OCRç»“æœä¸­æå–é‡‘é¢
        function extractAmountsFromOCR(text, words) {
            // æ–¹æ³•1: ä»è¯†åˆ«çš„æ–‡æœ¬ä¸­æå–é‡‘é¢
            const amountRegex = /(\d+\.\d{2})å…ƒ?/g;
            const matches = [...text.matchAll(amountRegex)];
            const amountsFromText = matches.map(m => parseFloat(m[1])).filter(a => a >= 0.01 && a < 1000);
            
            // æ–¹æ³•2: ä»å•è¯ä¸­æå–æ•°å­—
            const numericWords = [];
            const numRegex = /(\d+\.\d{2}|\d+)/;
            
            if (words) {
                words.forEach(word => {
                    const match = word.text.match(numRegex);
                    if (match && !word.text.includes(':') && word.confidence > 50) {
                        const value = parseFloat(match[1]);
                        if (!isNaN(value) && value >= 0.01 && value < 1000) {
                            numericWords.push({
                                value: value,
                                text: word.text,
                                confidence: word.confidence
                            });
                        }
                    }
                });
            }
            
            // ä¼˜å…ˆä½¿ç”¨ä»æ–‡æœ¬ä¸­æå–çš„é‡‘é¢ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä»å•è¯ä¸­æå–çš„
            if (amountsFromText.length >= numericWords.length) {
                recognizedAmounts = amountsFromText.map(value => ({ value }));
            } else {
                recognizedAmounts = numericWords;
            }
            
            // å¦‚æœä»ç„¶æ²¡æœ‰è¯†åˆ«åˆ°é‡‘é¢ï¼Œå°è¯•æ›´å®½æ¾çš„åŒ¹é…
            if (recognizedAmounts.length === 0) {
                const fallbackMatches = text.match(/\d+\.\d{2}/g) || [];
                recognizedAmounts = fallbackMatches.map(value => ({ value: parseFloat(value) }))
                    .filter(a => a.value >= 0.01 && a.value < 1000);
            }
            
            if (recognizedAmounts.length === 0) {
                showStatus('æœªè¯†åˆ«åˆ°ä»»ä½•é‡‘é¢ï¼Œè¯·è°ƒæ•´è£åˆ‡åŒºåŸŸæˆ–å°è¯•æ›´æ¸…æ™°çš„å›¾ç‰‡', 'error');
                return;
            }
            
            // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
            renderAmountList();
            computeAndShowTails();
            
            // å‡†å¤‡æ•°æ®
            prepareOCRData();
            
            // åˆ‡æ¢åˆ°ç»“æœæ ‡ç­¾
            switchTab('resultTab');
            showStatus('è¯†åˆ«å®Œæˆï¼è¯·æ ¸å¯¹ç»“æœ', 'success');
        }
        
        // æ¸²æŸ“é‡‘é¢åˆ—è¡¨
        function renderAmountList() {
            const amountList = document.getElementById('amountList');
            amountList.innerHTML = '';
            
            if (!recognizedAmounts.length) {
                amountList.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">æ— è¯†åˆ«æ•°æ®</div>';
                return;
            }
            
            recognizedAmounts.forEach((amount, index) => {
                const item = document.createElement('div');
                item.className = 'amount-item';
                if (amount.anomaly) {
                    item.style.backgroundColor = '#ffebee';
                }
                item.innerHTML = `
                    <div>
                        <input type="number" step="0.01" min="0.01" value="${amount.value.toFixed(2)}" 
                            data-index="${index}" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;${amount.anomaly ? ' border-color: #f44336;' : ''}">
                        å…ƒ
                        ${amount.anomaly ? `<div style="font-size: 0.8rem; color: #f44336;">å»ºè®®: ${amount.suggested.toFixed(2)}</div>` : ''}
                    </div>
                    <div>
                        <button class="btn-small btn-outline" data-remove="${index}">åˆ é™¤</button>
                    </div>
                `;
                amountList.appendChild(item);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                item.querySelector('input').addEventListener('change', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-index'));
                    const newValue = parseFloat(e.target.value);
                    if (!isNaN(newValue) && newValue > 0) {
                        recognizedAmounts[idx].value = newValue;
                        recognizedAmounts[idx].anomaly = false; // ä¿®æ­£åç§»é™¤å¼‚å¸¸æ ‡è®°
                        computeAndShowTails();
                        prepareOCRData(); // é‡æ–°å‡†å¤‡æ•°æ®
                    }
                });
                
                item.querySelector('[data-remove]').addEventListener('click', (e) => {
                    const idx = parseInt(e.target.getAttribute('data-remove'));
                    recognizedAmounts.splice(idx, 1);
                    renderAmountList();
                    computeAndShowTails();
                    prepareOCRData(); // é‡æ–°å‡†å¤‡æ•°æ®
                });
            });
            
            // æ˜¾ç¤ºé‡‘é¢åˆ—è¡¨å®¹å™¨
            document.getElementById('amountListContainer').style.display = 'block';
        }
        
        // è®¡ç®—å¹¶æ˜¾ç¤ºå°¾æ•°
        function computeAndShowTails() {
            if (!recognizedAmounts.length) return;
            
            // è®¡ç®—å°¾æ•°åˆ†å¸ƒ
            const tailCount = {};
            let totalAmount = 0;
            
            recognizedAmounts.forEach(amount => {
                totalAmount += amount.value;
                // è·å–åˆ†çš„æœ€åä¸€ä½æ•°å­—
                const cents = Math.round(amount.value * 100);
                const tail = cents % 10;
                tailCount[tail] = (tailCount[tail] || 0) + 1;
            });
            
            // æ˜¾ç¤ºç»“æœ
            const ocrResult = document.getElementById('ocrResult');
            let html = `
                <div class="result-card">
                    <p><strong>è¯†åˆ«ç»“æœ:</strong></p>
                    <p>è¯†åˆ«åˆ° <strong>${recognizedAmounts.length}</strong> ä¸ªçº¢åŒ…ï¼Œæ€»è®¡ <strong>${totalAmount.toFixed(2)}</strong> å…ƒ</p>
                    <p><strong>å°¾æ•°åˆ†å¸ƒ:</strong></p>
            `;
            
            // æŒ‰å‡ºç°æ¬¡æ•°æ’åº
            const sortedTails = Object.entries(tailCount)
                .sort((a, b) => b[1] - a[1])
                .map(([tail, count]) => {
                    const percentage = (count / recognizedAmounts.length * 100).toFixed(1);
                    return `<span class="tail-tag">${tail} (${count}æ¬¡, ${percentage}%)</span>`;
                });
            
            html += sortedTails.join(' ') + '</div>';
            ocrResult.innerHTML = html;
        }
        
        // å‡†å¤‡OCRæ•°æ®
        function prepareOCRData() {
            if (!recognizedAmounts.length) return;
            
            const totalAmount = recognizedAmounts.reduce((sum, item) => sum + item.value, 0);
            const packetCount = recognizedAmounts.length;
            
            // è®¡ç®—å°¾æ•°
            const tails = recognizedAmounts.map(amount => {
                const cents = Math.round(amount.value * 100);
                return cents % 10;
            });
            
            currentOCRData = {
                timestamp: new Date().toISOString(),
                totalAmount,
                packetCount,
                amounts: recognizedAmounts.map(a => a.value),
                tails,
                rawText: "OCRè¯†åˆ«æ•°æ®"
            };
        }
        
        // ä¿å­˜æ‰‹åŠ¨è¾“å…¥çš„æ•°æ®
        function saveManualData() {
            const totalAmount = parseFloat(document.getElementById('manualTotalAmount').value);
            const packetCount = parseInt(document.getElementById('manualPacketCount').value);
            
            if (isNaN(totalAmount) || totalAmount <= 0) {
                showStatus('è¯·è¾“å…¥æ­£ç¡®çš„æ€»é‡‘é¢', 'error');
                return;
            }
            
            if (isNaN(packetCount) || packetCount <= 0) {
                showStatus('è¯·è¾“å…¥æ­£ç¡®çš„çº¢åŒ…ä¸ªæ•°', 'error');
                return;
            }
            
            // è·å–æ‰€æœ‰æ‰‹åŠ¨è¾“å…¥çš„é‡‘é¢
            const amountInputs = document.querySelectorAll('.manual-amount');
            const amounts = [];
            
            for (let i = 0; i < amountInputs.length; i++) {
                const amount = parseFloat(amountInputs[i].value);
                if (!isNaN(amount) && amount > 0) {
                    amounts.push(amount);
                }
            }
            
            if (amounts.length === 0) {
                showStatus('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„é‡‘é¢', 'error');
                return;
            }
            
            // è®¡ç®—å°¾æ•°
            const tails = amounts.map(amount => {
                const cents = Math.round(amount * 100) % 10;
                return cents;
            });
            
            currentOCRData = {
                timestamp: new Date().toISOString(),
                totalAmount,
                packetCount,
                amounts,
                tails,
                rawText: "æ‰‹åŠ¨è¾“å…¥æ•°æ®",
                isManual: true
            };
            
            // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
            displayOCRResult(currentOCRData);
            openCorrectionInterface(currentOCRData);
            
            // åˆ‡æ¢åˆ°ç»“æœæ ‡ç­¾
            switchTab('resultTab');
            showStatus('æ‰‹åŠ¨è¾“å…¥æ•°æ®å·²åŠ è½½ï¼Œè¯·ç¡®è®¤åä¿å­˜', 'success');
        }
        
        // æ˜¾ç¤ºOCRè¯†åˆ«ç»“æœ
        function displayOCRResult(data) {
            const ocrResult = document.getElementById('ocrResult');
            ocrResult.innerHTML = `
                <div class="result-card">
                    <p><strong>${data.isManual ? 'æ‰‹åŠ¨è¾“å…¥' : 'è¯†åˆ«'}ç»“æœ:</strong></p>
                    <p>æ€»é‡‘é¢: ${data.totalAmount.toFixed(2)}å…ƒ</p>
                    <p>çº¢åŒ…ä¸ªæ•°: ${data.packetCount}ä¸ª</p>
                    <p>é‡‘é¢åˆ—è¡¨: ${data.amounts.map(a => a.toFixed(2)).join(', ')}</p>
                    <p>å°¾æ•°: ${data.tails.join(', ')}</p>
                </div>
            `;
        }
        
        // æ‰“å¼€æ ¡æ­£ç•Œé¢
        function openCorrectionInterface(data) {
            const correctionArea = document.getElementById('correctionArea');
            correctionArea.innerHTML = `
                <div class="result-card">
                    <h4>è¯·æ ¸å¯¹${data.isManual ? 'æ‰‹åŠ¨è¾“å…¥' : 'è¯†åˆ«'}ç»“æœï¼Œå¦‚æœ‰é”™è¯¯è¯·ä¿®æ”¹:</h4>
                    <p>æ€»é‡‘é¢: <input type="number" step="0.01" id="correctTotalAmount" value="${data.totalAmount}"> å…ƒ</p>
                    <p>çº¢åŒ…ä¸ªæ•°: <input type="number" id="correctPacketCount" value="${data.packetCount}"> ä¸ª</p>
                    <div id="amountCorrections">
                        ${data.amounts.map((amount, index) => `
                            <p>çº¢åŒ…${index+1}: <input type="number" step="0.01" value="${amount.toFixed(2)}" data-index="${index}"> å…ƒ</p>
                        `).join('')}
                    </div>
                    <button class="success" onclick="saveCorrectedData()">ä¿å­˜æ ¡æ­£åçš„æ•°æ®</button>
                </div>
            `;
        }
        
        // ä¿å­˜æ ¡æ­£åçš„æ•°æ®
        function saveCorrectedData() {
            if (!currentOCRData) return;
            
            // è·å–æ ¡æ­£åçš„å€¼
            const correctedTotalAmount = parseFloat(document.getElementById('correctTotalAmount').value) || currentOCRData.totalAmount;
            const correctedPacketCount = parseInt(document.getElementById('correctPacketCount').value) || currentOCRData.packetCount;
            
            // è·å–æ ¡æ­£åçš„æ¯ä¸ªçº¢åŒ…é‡‘é¢
            const correctedAmounts = [];
            const amountInputs = document.querySelectorAll('#amountCorrections input');
            amountInputs.forEach(input => {
                const amount = parseFloat(input.value);
                if (!isNaN(amount) && amount > 0) {
                    correctedAmounts.push(amount);
                }
            });
            
            // æ›´æ–°æ•°æ®
            currentOCRData.totalAmount = correctedTotalAmount;
            currentOCRData.packetCount = correctedPacketCount;
            currentOCRData.amounts = correctedAmounts;
            currentOCRData.tails = correctedAmounts.map(amount => Math.round(amount * 100) % 10);
            
            saveData();
        }
        
        // ä¿å­˜æ•°æ®
        function saveData() {
            if (!currentOCRData) return;
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            redPacketHistory.push(currentOCRData);
            localStorage.setItem('redPacketHistory', JSON.stringify(redPacketHistory));
            
            // æ›´æ–°æ˜¾ç¤º
            updateHistoryDisplay();
            generatePrediction();
            displayCurrentData(currentOCRData);
            
            showStatus('æ•°æ®ä¿å­˜æˆåŠŸï¼é¢„æµ‹ç»“æœå·²æ›´æ–°', 'success');
            setTimeout(() => {
                closeUploadModal();
            }, 1500);
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'error') {
                statusElement.classList.add('error');
            } else if (type === 'success') {
                statusElement.classList.add('success');
            }
        }
        
        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            
            if (redPacketHistory.length === 0) {
                historyList.innerHTML = '<p>æš‚æ— å†å²è®°å½•ï¼Œè¯·ä¸Šä¼ ç¬¬ä¸€ä¸ªçº¢åŒ…æˆªå›¾</p>';
                return;
            }
            
            historyList.innerHTML = redPacketHistory.slice().reverse().map((record, index) => `
                <div class="history-item">
                    <p><strong>è®°å½• ${redPacketHistory.length - index}</strong> - 
                       ${new Date(record.timestamp).toLocaleString()} - 
                       æ€»é‡‘é¢: ${record.totalAmount.toFixed(2)}å…ƒ</p>
                    <p>é‡‘é¢åˆ—è¡¨: ${record.amounts.map(a => a.toFixed(2)).join(', ')}</p>
                    <p>å°¾æ•°: ${record.tails.join(', ')}</p>
                    <button class="correct-btn" onclick="reanalyzeRecord(${redPacketHistory.length - 1 - index})">é‡æ–°åˆ†æ</button>
                </div>
            `).join('');
        }
        
        // æ˜¾ç¤ºå½“å‰æ•°æ®
        function displayCurrentData(data) {
            const currentDataDiv = document.getElementById('currentData');
            currentDataDiv.innerHTML = `
                <div class="result-card">
                    <p><strong>æ€»é‡‘é¢:</strong> ${data.totalAmount.toFixed(2)}å…ƒ</p>
                    <p><strong>çº¢åŒ…ä¸ªæ•°:</strong> ${data.packetCount}ä¸ª</p>
                    <p><strong>é‡‘é¢åˆ—è¡¨:</strong> ${data.amounts.map(a => a.toFixed(2)).join(', ')}</p>
                    <p><strong>å°¾æ•°:</strong> ${data.tails.join(', ')}</p>
                </div>
            `;
        }
        
        // é«˜çº§é¢„æµ‹ç®—æ³•ï¼ˆåŸºäºå†å²æ•°æ®ï¼‰- æ¥è‡ª008ç¨‹åº
        function advancedPredictionWithHistory() {
            if (redPacketHistory.length === 0) return [3, 6, 9]; // é»˜è®¤å€¼
            
            const currentData = redPacketHistory[redPacketHistory.length - 1];
            const allTails = redPacketHistory.flatMap(record => record.tails);
            
            // å¤šç»´åº¦åˆ†æ
            const predictions = {
                // æ–¹æ³•1: é¢‘ç‡åŠ æƒåˆ†æ
                frequencyWeighted: frequencyWeightedAnalysis(allTails),
                
                // æ–¹æ³•2: æ—¶é—´åºåˆ—åˆ†æ
                timeSeries: timeSeriesAnalysis(redPacketHistory),
                
                // æ–¹æ³•3: æ¨¡å¼è¯†åˆ«åˆ†æ
                patternRecognition: patternRecognitionAnalysis(redPacketHistory),
                
                // æ–¹æ³•4: æ¦‚ç‡åå·®åˆ†æ
                probabilityBias: probabilityBiasAnalysis(allTails)
            };
            
            // ç»¼åˆè¯„åˆ†
            return comprehensiveScoring(predictions);
        }
        
        // é¢‘ç‡åŠ æƒåˆ†æ
        function frequencyWeightedAnalysis(allTails) {
            const freq = {};
            allTails.forEach(tail => {
                freq[tail] = (freq[tail] || 0) + 1;
            });
            
            // æŒ‰é¢‘ç‡æ’åºï¼Œé€‰æ‹©å‰3ä¸ª
            return Object.keys(freq)
                .sort((a, b) => freq[b] - freq[a])
                .slice(0, 3)
                .map(Number);
        }
        
        // æ—¶é—´åºåˆ—åˆ†æ
        function timeSeriesAnalysis(history) {
            if (history.length < 2) return [0, 1, 2]; // é»˜è®¤å€¼
            
            const recentTails = history.slice(-5).flatMap(record => record.tails);
            const changes = [];
            
            for (let i = 1; i < recentTails.length; i++) {
                changes.push((recentTails[i] - recentTails[i-1] + 10) % 10);
            }
            
            const avgChange = changes.reduce((a, b) => a + b, 0) / changes.length;
            const lastTail = recentTails[recentTails.length - 1];
            const predicted = Math.round((lastTail + avgChange) % 10);
            
            return [predicted, (predicted + 3) % 10, (predicted + 7) % 10];
        }
        
        // æ¨¡å¼è¯†åˆ«åˆ†æ
        function patternRecognitionAnalysis(history) {
            // åˆ†æå†å²ä¸­çš„å°¾æ•°ç»„åˆæ¨¡å¼
            const tailPatterns = [];
            
            for (let i = 0; i < history.length - 1; i++) {
                tailPatterns.push({
                    previous: history[i].tails,
                    next: history[i+1].tails
                });
            }
            
            // ç®€åŒ–ç‰ˆï¼šå¯»æ‰¾æœ€è¿‘ç›¸ä¼¼æ¨¡å¼
            if (tailPatterns.length === 0) return [3, 6, 9];
            
            const currentTails = history[history.length - 1].tails;
            let bestMatch = tailPatterns[0];
            let minDifference = Infinity;
            
            tailPatterns.forEach(pattern => {
                const diff = calculateTailDifference(pattern.previous, currentTails);
                if (diff < minDifference) {
                    minDifference = diff;
                    bestMatch = pattern;
                }
            });
            
            return [...new Set(bestMatch.next)].slice(0, 3);
        }
        
        // æ¦‚ç‡åå·®åˆ†æ
        function probabilityBiasAnalysis(allTails) {
            const total = allTails.length;
            const expectedProb = 0.1; // æ¯ä¸ªå°¾æ•°ç†è®ºæ¦‚ç‡10%
            const deviations = {};
            
            for (let i = 0; i < 10; i++) {
                const actualCount = allTails.filter(tail => tail === i).length;
                const actualProb = actualCount / total;
                deviations[i] = Math.abs(actualProb - expectedProb);
            }
            
            // é€‰æ‹©åå·®æœ€å¤§çš„ï¼ˆæœ€å¯èƒ½å›å½’å¹³å‡ï¼‰
            return Object.keys(deviations)
                .sort((a, b) => deviations[b] - deviations[a])
                .slice(0, 3)
                .map(Number);
        }
        
        // ç»¼åˆè¯„åˆ†ç®—æ³•
        function comprehensiveScoring(predictions) {
            const scoreMap = {};
            const methods = Object.values(predictions);
            
            methods.forEach(method => {
                method.forEach((tail, index) => {
                    const score = 3 - index; // æ’åè¶Šé«˜åˆ†æ•°è¶Šé«˜
                    scoreMap[tail] = (scoreMap[tail] || 0) + score;
                });
            });
            
            // æŒ‰ç»¼åˆå¾—åˆ†æ’åºï¼Œé€‰æ‹©å‰3ä¸ª
            return Object.keys(scoreMap)
                .sort((a, b) => scoreMap[b] - scoreMap[a])
                .slice(0, 3)
                .map(Number);
        }
        
        // è®¡ç®—å°¾æ•°å·®å¼‚
        function calculateTailDifference(tails1, tails2) {
            // ç®€åŒ–å·®å¼‚è®¡ç®—
            return Math.abs(tails1.reduce((a, b) => a + b, 0) - tails2.reduce((a, b) => a + b, 0));
        }
        
        // ç”Ÿæˆé¢„æµ‹
        function generatePrediction() {
            if (redPacketHistory.length === 0) return;
            
            const prediction = advancedPredictionWithHistory();
            const currentData = redPacketHistory[redPacketHistory.length - 1];
            
            // è®¡ç®—ç½®ä¿¡åº¦
            const confidence = redPacketHistory.length < 3 ? 'low' : 
                              redPacketHistory.length < 10 ? 'medium' : 'high';
            
            // æ˜¾ç¤ºé¢„æµ‹ç»“æœ
            const predictionResult = document.getElementById('predictionResult');
            predictionResult.innerHTML = `
                <div class="prediction-result">
                    <h3>ğŸ¯ ä¸‹ä¸€æ¬¡çº¢åŒ…é¢„æµ‹ç»“æœ</h3>
                    <p>åŸºäº <strong>${redPacketHistory.length}</strong> æ¡å†å²è®°å½•åˆ†æ</p>
                    <p>æ¨èé‡‘é¢: <strong>${currentData.totalAmount.toFixed(2)}å…ƒ</strong> (${currentData.packetCount}ä¸ªåŒ…)</p>
                    <p>é¢„æµ‹å°¾æ•°: </p>
                    <div>
                        ${prediction.map(tail => `<span class="tail-number">${tail}</span>`).join('')}
                    </div>
                    <p>ç½®ä¿¡åº¦: <span class="confidence-${confidence}">${confidence === 'high' ? 'é«˜' : confidence === 'medium' ? 'ä¸­' : 'ä½'}</span></p>
                </div>
            `;
            
            // æ›´æ–°å›¾è¡¨
            updateTailDistributionChart();
        }
        
        // æ›´æ–°å°¾æ•°åˆ†å¸ƒå›¾è¡¨
        function updateTailDistributionChart() {
            const allTails = redPacketHistory.flatMap(record => record.tails);
            const tailCounts = Array(10).fill(0);
            
            allTails.forEach(tail => {
                tailCounts[tail]++;
            });
            
            const ctx = document.getElementById('tailDistributionChart').getContext('2d');
            
            if (tailDistributionChart) {
                tailDistributionChart.destroy();
            }
            
            tailDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
                    datasets: [{
                        label: 'å°¾æ•°å‡ºç°æ¬¡æ•°',
                        data: tailCounts,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å‡ºç°æ¬¡æ•°'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å°¾æ•°'
                            }
                        }
                    }
                }
            });
        }
        
        // é‡æ–°åˆ†æè®°å½•
        function reanalyzeRecord(index) {
            const record = redPacketHistory[index];
            currentOCRData = {...record};
            displayOCRResult(currentOCRData);
            openCorrectionInterface(currentOCRData);
            
            // æ‰“å¼€ä¸Šä¼ æ¨¡æ€æ¡†å¹¶åˆ‡æ¢åˆ°ç»“æœæ ‡ç­¾
            openUploadModal();
            switchTab('resultTab');
        }
    </script>
</body>
</html>